@model IEnumerable<Swift.Core.JobConfig>

@{
    ViewBag.Title = "作业";
}

<h2>集群 @ViewBag.ClusterName 作业</h2>

@section header{
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
}

@section scripts{
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/plugins/piexif.min.js" type="text/javascript"></script>
    <!-- sortable.min.js is only needed if you wish to sort / rearrange files in initial preview.
        This must be loaded before fileinput.min.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/plugins/sortable.min.js" type="text/javascript"></script>
    <!-- purify.min.js is only needed if you wish to purify HTML content in your preview for
        HTML files. This must be loaded before fileinput.min.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/plugins/purify.min.js" type="text/javascript"></script>
    <!-- the main fileinput plugin file -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/fileinput.min.js"></script>
    <!-- optionally if you need a theme like font awesome theme you can include it as mentioned below -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/themes/fa/theme.js"></script>
    <!-- optionally if you need translation for your language then include  locale file as mentioned below -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/4.4.9/js/locales/zh.js"></script>
    <script type="text/javascript">
    $("#jobPkgFile").fileinput({
            uploadUrl:"/Job/Upload",//上传的地址
            uploadAsync: true,
            language : "zh",//设置语言
            showCaption: true,//是否显示标题
            showPreview:false,
            showUpload: false, //是否显示上传按钮
            dropZoneEnabled:false, //是否允许拖拽上传
            browseClass: "btn btn-primary", //按钮样式
            allowedFileExtensions: ["zip"], //接收的文件后缀
            maxFileCount: 1,//最大上传文件数限制
            uploadAsync: true,
            uploadExtraData: function() {
                return {"clustername":"@ViewBag.ClusterName"};
            }
    });

    $("#jobPkgFile").on("fileuploaded", function(event, data, previewId, index) {
        alert("发布成功!");
        window.location.reload();
    });

    $('#jobPkgFile').on('fileuploaderror', function(event, data, msg) {
        alert("发布失败："+msg);
        window.location.reload();
    });

     $("#btnUploadPkgFile").click(function(){
        $('#jobPkgFile').fileinput('upload');
     });
    </script>
}

<p>
    <a class="btn btn-info" href="javascript:history.back()">返回</a>
    <a class="btn btn-info" href="javascript:location.reload()">刷新</a>
</p>

<div id="job-publish">
    <h3>发布作业</h3>
    <p><input id="jobPkgFile" name="jobPkgFile" class="flie" type="file"></p>
    <p class="text-right"><button id="btnUploadPkgFile" type="button" class="btn btn-primary">上传并发布</button></p>
    @*<div class="row">
        <div class="col-md-9"></div>
        <div class="col-md-3 vertical-center"></div>
    </div>*@
</div>
@*
    // TODO:增加清空执行时间操作，以关闭作业运行
*@
<div id="jobs-list">
    <table class="table table-striped table-hover">
        <tr>
            <th>
                作业名称
            </th>
            <th>
                当前版本
            </th>
            <th>
                可执行文件名称
            </th>
            <th>
                定时执行时间
            </th>
            <th>
                最新执行Id
            </th>
            <th>
                最新执行启动时间
            </th>
            <th>
                历史记录
            </th>
        </tr>

        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Version)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.FileName)
                </td>
                <td>
                    @string.Join(",", item.RunTimePlan)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.LastRecordId)
                </td>
                <td>
                    @(item.LastRecordStartTime.HasValue?item.LastRecordStartTime.Value.ToString("yyyy-MM-dd HH:mm:ss"):string.Empty)
                </td>
                <td>
                    @Html.ActionLink("查看", "JobRecords", new { job = item.Name, cluster = ViewBag.ClusterName })
                </td>
            </tr>
        }
    </table>
</div>